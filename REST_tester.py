
import cv2
import numpy as np


def adjust_gamma(image, gamma=1.0):
    # build a lookup table mapping the pixel values [0, 255] to
    # their adjusted gamma values
    invGamma = 1.0 / gamma
    table = np.array([((i / 255.0) ** invGamma) * 255
                      for i in np.arange(0, 256)]).astype("uint8")
    # apply gamma correction using the lookup table
    return cv2.LUT(image, table)


main_path = "c:\\applications\\DKFace\\"
shape_predictor = "shape_predictor_68_face_landmarks.dat"
recognizer_model = "dlib_face_recognition_resnet_model_v1.dat"
images_directory = "Users"
train_file_name = "DK_trainedFacialDescriptors.npy"
# train_file_name = "TESTE.npy"
indexes_file_name = "DK_indexes.pickle"
# indexes_file_name = "TESTE.pickle"
camera = "0"
# ('rtsp://username:password@192.168.1.64/1')
# camera = "rtsp://dankia:dankia77@192.168.1.21:554/1"
# camera = "rtsp://192.168.1.27:554/user=dankia&password=dankia77&channel=1&stream=0.sdp"
width = 1024
height = 768
threshold = 0.5
upsample_rate = 0
recognize_ms = 1
image_px = 200
descriptors_directory = "Users"
ufd_full_path = main_path + descriptors_directory + "\\UFD.1.json"

BASE = "http://127.0.0.1:5000/"

# response = requests.get(BASE + "detect/"+main_path+"/lastCapture.png/"+str(image_px)+"/"+str(upsample_rate)+"/")
# response = requests.get(BASE + "test/"+camera)
# response = requests.get(BASE + "watch/"+camera+"/"+str(width)+"/"+str(height))
# response = requests.get(BASE + "detect/"+camera+"/"+str(width)+"/"+str(height)+"/"+str(upsample_rate))
# data = [{"index": 168746, "name": "Useasdasd.png", "descriptors": "[-0.11194104701280594, 0.1365036964416504, 0.08939716964960098, -0.04824931547045708, -0.11496135592460632, 0.02659076824784279, -0.13705728948116302, -0.04822380468249321, 0.09278682619333267, -0.09466160088777542, 0.23835918307304382, 0.09636501967906952, -0.21652299165725708, 0.031742192804813385, 0.021893644705414772, 0.11437369883060455, -0.15551571547985077, -0.1400470733642578, -0.06950411200523376, -0.03378354758024216, 0.004434866830706596, 0.0862276703119278, 0.025918181985616684, 0.06159617379307747, -0.12522965669631958, -0.32295742630958557, -0.05318762734532356, -0.07539897412061691, 0.12323343753814697, -0.1429174244403839, -0.05206632614135742, -0.08345208317041397, -0.13054800033569336, 0.035756826400756836, 0.07981064915657043, 0.08681128919124603, -0.06559337675571442, -0.09008635580539703, 0.2494417279958725, 0.048484452068805695, -0.18468032777309418, 0.019597195088863373, 0.01060008816421032, 0.30243679881095886, 0.17149046063423157, 0.051242634654045105, 0.03682886064052582, -0.05923883989453316, 0.09772096574306488, -0.2640226483345032, 0.09382665157318115, 0.17045390605926514, 0.055043525993824005, 0.05457746982574463, 0.09320642054080963, -0.17434826493263245, 0.015311067923903465, 0.12083998322486877, -0.18641841411590576, 0.09805285185575485, 0.029374558478593826, -0.07983769476413727, -0.027556486427783966, -0.05549269914627075, 0.20663617551326752, 0.09509695321321487, -0.12422335147857666, -0.11863337457180023, 0.13889285922050476, -0.16094380617141724, -0.06536827981472015, 0.06498993933200836, -0.09701915830373764, -0.17180964350700378, -0.19820299744606018, 0.02689228393137455, 0.37362155318260193, 0.1824612319469452, -0.18100756406784058, 0.05713752657175064, 0.034062936902046204, -0.06891757994890213, 0.04352705553174019, 0.11597395688295364, -0.10197995603084564, 0.0011970438063144684, -0.04852703586220741, 0.08077964186668396, 0.19888338446617126, 0.02239222638309002, 0.05226344242691994, 0.2389925718307495, 0.023865504190325737, 0.027888670563697815, 0.08752971887588501, 0.0756826102733612, -0.09149085730314255, -0.07587224990129471, -0.09365169703960419, -0.03188050538301468, 0.03521221503615379, -0.10076047480106354, 0.049532707780599594, 0.12663370370864868, -0.2066233605146408, 0.13438117504119873, -0.021594757214188576, -0.0465376079082489, 0.05068618059158325, 0.09378794580698013, -0.07083374261856079, -0.11187967658042908, 0.14972485601902008, -0.25448355078697205, 0.21093274652957916, 0.24039995670318604, 0.030942397192120552, 0.1036495715379715, 0.05118095129728317, 0.06472128629684448, 0.01992260292172432, 0.006113323848694563, -0.13481462001800537, -0.10253605246543884, -0.03093813732266426, -0.05408164858818054, 0.027166932821273804, 0.02040228061378002]", "userId": 1, "jsonName": "UFD.1.json"}, {"index": 6, "name": "User.1.Dankia.2.png", "descriptors": "[-0.1131872907280922, 0.09418072551488876, 0.12529540061950684, -0.06610820442438126, -0.0952075943350792, 0.06314161419868469, -0.16325031220912933, -0.003930149599909782, 0.08205854147672653, -0.09364457428455353, 0.21607501804828644, 0.09811411798000336, -0.2078060358762741, 0.031185878440737724, 0.0045378562062978745, 0.10574017465114594, -0.14860138297080994, -0.11096195131540298, -0.049655914306640625, -0.03782382234930992, 0.01767599582672119, 0.13011206686496735, 0.020365247502923012, 0.024483900517225266, -0.12051993608474731, -0.3575141429901123, -0.07172191888093948, -0.07011158019304276, 0.10055401921272278, -0.16386646032333374, -0.04882713779807091, -0.05992378294467926, -0.11693155765533447, 0.0447566919028759, 0.06801384687423706, 0.08649492263793945, -0.007249254733324051, -0.04840930923819542, 0.20954349637031555, 0.08761541545391083, -0.14148977398872375, 0.0277638528496027, 0.022846683859825134, 0.32202455401420593, 0.1638459414243698, 0.06873264163732529, 0.03605575114488602, -0.05547608435153961, 0.09908462315797806, -0.27078869938850403, 0.09624182432889938, 0.1596543788909912, 0.0699089914560318, 0.036771997809410095, 0.1037026196718216, -0.15561115741729736, -0.002871120348572731, 0.10472958534955978, -0.1736433357000351, 0.15410499274730682, 0.031277332454919815, -0.037092700600624084, -0.02880890667438507, -0.05445937067270279, 0.19531117379665375, 0.09616149216890335, -0.1319313943386078, -0.12485969811677933, 0.14305293560028076, -0.12567931413650513, -0.0696859210729599, 0.018785003572702408, -0.13435889780521393, -0.15160426497459412, -0.21015402674674988, 0.02930966392159462, 0.38167524337768555, 0.16884279251098633, -0.21366433799266815, 0.049870338290929794, 0.018085725605487823, -0.06305941939353943, 0.04207289218902588, 0.1114187091588974, -0.11430257558822632, 0.012734061107039452, -0.026348795741796494, 0.11039018630981445, 0.18500404059886932, 0.04237504303455353, 0.0438506156206131, 0.21317996084690094, 0.02374950423836708, 0.0722978264093399, 0.08369936794042587, 0.06947959214448929, -0.10126657783985138, -0.08041458576917648, -0.1476353108882904, -0.03353540599346161, -0.004456290043890476, -0.08221820741891861, 0.06417704373598099, 0.1628584861755371, -0.1760328859090805, 0.16492195427417755, -0.01235954649746418, -0.06997942924499512, 0.042081866413354874, 0.13832785189151764, -0.08718080073595047, -0.10061056166887283, 0.15829779207706451, -0.20553380250930786, 0.17683960497379303, 0.24313411116600037, 0.054859552532434464, 0.09414590895175934, 0.06588444113731384, 0.08664468675851822, 0.020203065127134323, 0.04597768932580948, -0.13653065264225006, -0.0853034257888794, -0.050882067531347275, -0.06071409210562706, 0.00900617241859436, 0.02588370442390442]", "userId": 1, "jsonName": "UFD.1.json"}, {"index": 7, "name": "User.1.Dankia.3.png", "descriptors": "[-0.1291693150997162, 0.06865797191858292, 0.09574202448129654, -0.05266713351011276, -0.09467532485723495, -0.005621648393571377, -0.11309966444969177, -0.05278901755809784, 0.1177445650100708, -0.10281018167734146, 0.18107856810092926, 0.10435590893030167, -0.22868041694164276, 0.05360095947980881, 0.021275710314512253, 0.11457133293151855, -0.1700405478477478, -0.13651210069656372, -0.08101369440555573, -0.03455263376235962, 0.028654126450419426, 0.09523433446884155, 0.02040845900774002, 0.04725092276930809, -0.08479295670986176, -0.36554545164108276, -0.09818751364946365, -0.043808307498693466, 0.11686572432518005, -0.06596895307302475, -0.0281248539686203, -0.055806130170822144, -0.11827787756919861, 0.0602363646030426, 0.09530479460954666, 0.0634535625576973, -0.052335627377033234, -0.07175017893314362, 0.2249569296836853, 0.08874858915805817, -0.20078504085540771, 0.01963706687092781, 0.020375721156597137, 0.29578709602355957, 0.19515849649906158, 0.08634153753519058, 0.02217651531100273, -0.04210107773542404, 0.08069545030593872, -0.28772690892219543, 0.09459447860717773, 0.18203984200954437, 0.0695279911160469, 0.03973077982664108, 0.13479965925216675, -0.19377832114696503, 0.012049145996570587, 0.11073748022317886, -0.20003455877304077, 0.10639037936925888, 0.015639984980225563, -0.10355169326066971, -0.03316093236207962, -0.038297027349472046, 0.1692747175693512, 0.1161113977432251, -0.12019340693950653, -0.12858830392360687, 0.1789025068283081, -0.1823960691690445, -0.037395160645246506, 0.04655326530337334, -0.1174861267209053, -0.17885908484458923, -0.183722123503685, 0.0021406318992376328, 0.3836136758327484, 0.19523848593235016, -0.18553370237350464, 0.036938928067684174, 0.028105400502681732, -0.0446072556078434, 0.05903582647442818, 0.1130165085196495, -0.10013244301080704, -0.024855315685272217, -0.0719250738620758, 0.04988531023263931, 0.16436877846717834, 0.026532962918281555, 0.047858428210020065, 0.26222100853919983, 0.03838716074824333, 0.014074104838073254, 0.06555430591106415, 0.053418613970279694, -0.10049409419298172, -0.09441468864679337, -0.13854306936264038, -0.08839890360832214, 0.011314411647617817, -0.056535184383392334, 0.052918270230293274, 0.13088344037532806, -0.19455498456954956, 0.14575797319412231, -0.019756697118282318, -0.06434591859579086, 0.019754286855459213, 0.07927925884723663, -0.05486968904733658, -0.09489453583955765, 0.11851669102907181, -0.21783655881881714, 0.18383945524692535, 0.25371167063713074, 0.03160757198929787, 0.11592835932970047, 0.00398991396650672, 0.048232220113277435, 0.011443445459008217, -0.01320630218833685, -0.13622437417507172, -0.09192100912332535, -0.0575081892311573, -0.0403531976044178, -0.008032163605093956, 0.017968934029340744]", "userId": 1, "jsonName": "UFD.1.json"}, {"index": 8, "name": "User.1.Dankia.4.png", "descriptors": "[-0.13952390849590302, 0.059030335396528244, 0.08357825130224228, -0.03433019667863846, -0.08402327448129654, -0.04200674593448639, -0.11703462153673172, -0.05531754344701767, 0.1495978683233261, -0.07513146847486496, 0.21881525218486786, 0.0389595627784729, -0.2405015230178833, 0.012625066563487053, -0.016579486429691315, 0.11750829219818115, -0.14868491888046265, -0.10102427005767822, -0.0817870944738388, -0.08974213153123856, 0.047879140824079514, 0.1089431419968605, 0.05563518404960632, 0.03598765283823013, -0.08747181296348572, -0.3828449547290802, -0.09434045106172562, -0.08738898485898972, 0.1472361981868744, -0.09349816292524338, -0.028980333358049393, -0.03118007816374302, -0.15735360980033875, -0.029878295958042145, 0.08335686475038528, 0.048011213541030884, 0.01177706103771925, -0.033311039209365845, 0.22796426713466644, 0.05331280082464218, -0.15324226021766663, -0.0060157086700201035, 0.03647391498088837, 0.29517754912376404, 0.152065247297287, 0.11271507292985916, 0.038455333560705185, -0.08437414467334747, 0.046614162623882294, -0.26589319109916687, 0.08619475364685059, 0.16026689112186432, 0.03404275327920914, 0.012852399609982967, 0.10509024560451508, -0.1698751449584961, -0.012315838597714901, 0.08289936929941177, -0.23368914425373077, 0.14970384538173676, 0.07119504362344742, -0.040191248059272766, -0.09002993255853653, -0.026107240468263626, 0.20614388585090637, 0.13482266664505005, -0.12249474227428436, -0.14244677126407623, 0.14075268805027008, -0.20776912569999695, -0.01840532198548317, 0.060222554951906204, -0.12477392703294754, -0.15499867498874664, -0.2588934600353241, -0.004975365474820137, 0.43930667638778687, 0.12607449293136597, -0.1626252382993698, 0.03322313725948334, 0.021258380264043808, -0.03624311834573746, 0.10923631489276886, 0.07517677545547485, -0.12538591027259827, 0.00651135016232729, -0.04322008043527603, 0.11332542449235916, 0.1651412844657898, 0.02855261042714119, -0.010168680921196938, 0.218413308262825, 0.014015988446772099, 0.0584954172372818, 0.06211692839860916, 0.10244645923376083, -0.07954873144626617, -0.11160619556903839, -0.14346793293952942, -0.029009805992245674, 0.0573100671172142, -0.021497752517461777, 0.07008481025695801, 0.11241643130779266, -0.1368849277496338, 0.08881545066833496, -0.02470230683684349, -0.08699703961610794, 0.0069790673442184925, 0.08596717566251755, -0.10107935220003128, -0.09723944962024689, 0.1490427404642105, -0.19590803980827332, 0.21138428151607513, 0.2372761368751526, 0.027455143630504608, 0.10030317306518555, 0.017868539318442345, 0.04359714314341545, 0.020120937377214432, 0.0234969574958086, -0.10607932507991791, -0.08362722396850586, -0.05008385702967644, -0.052003685384988785, 0.05194227769970894, -0.009892584756016731]", "userId": 1, "jsonName": "UFD.1.json"}, {"index": 9, "name": "User.1.Dankia.5.png", "descriptors": "[-0.10237833112478256, 0.08648742735385895, 0.09071633219718933, -0.053666986525058746, -0.08610410243272781, 0.03333389014005661, -0.12459583580493927, -0.020200351253151894, 0.12104871869087219, -0.10192842036485672, 0.20321229100227356, 0.08604729920625687, -0.26077207922935486, 0.03295223042368889, 0.026244336739182472, 0.09801538288593292, -0.1751367300748825, -0.10784047096967697, -0.0586027130484581, -0.04642898589372635, 0.018703768029808998, 0.09497124701738358, 0.046896956861019135, 0.04559101164340973, -0.10583105683326721, -0.36581024527549744, -0.08643823862075806, -0.07088887691497803, 0.11792757362127304, -0.11485899984836578, -0.03243802487850189, -0.05664738267660141, -0.10637301206588745, 0.03033127635717392, 0.06528838723897934, 0.060020603239536285, -0.008554988540709019, -0.06166716665029526, 0.23320356011390686, 0.08026313036680222, -0.15453855693340302, 0.016374483704566956, 0.016947999596595764, 0.32584699988365173, 0.16767607629299164, 0.08041658997535706, 0.03338731452822685, -0.05111560598015785, 0.08370932936668396, -0.26221373677253723, 0.08793910592794418, 0.16480359435081482, 0.0854436531662941, 0.010718096978962421, 0.10898957401514053, -0.18253779411315918, -0.0032162684947252274, 0.10319966077804565, -0.20526166260242462, 0.147221639752388, 0.03491786867380142, -0.06501368433237076, -0.03605727106332779, -0.0469253808259964, 0.20664672553539276, 0.10102975368499756, -0.14061984419822693, -0.12239862978458405, 0.16796395182609558, -0.15791480243206024, -0.04400557279586792, 0.029117349535226822, -0.13842789828777313, -0.158360555768013, -0.20798589289188385, 0.01545526273548603, 0.3953009247779846, 0.16842764616012573, -0.1872519850730896, 0.043658871203660965, 0.01547445822507143, -0.060345280915498734, 0.042616695165634155, 0.14084883034229279, -0.11958421021699905, -0.013174627907574177, -0.04405243322253227, 0.094564288854599, 0.15140566229820251, 0.030103014782071114, 0.024338249117136, 0.22708049416542053, 0.03162679821252823, 0.04812232404947281, 0.07503201067447662, 0.05294249951839447, -0.1154874712228775, -0.08129704743623734, -0.1467040330171585, -0.03899364173412323, 0.010111354291439056, -0.09482398629188538, 0.07098594307899475, 0.13800986111164093, -0.1767861247062683, 0.13391859829425812, -0.008596796542406082, -0.08325318992137909, 0.050400733947753906, 0.12562304735183716, -0.0870831161737442, -0.11019069701433182, 0.15645836293697357, -0.2339002937078476, 0.17308282852172852, 0.24912679195404053, 0.057959333062171936, 0.1068718209862709, 0.030240323394536972, 0.08926697075366974, 0.028092093765735626, 0.04389286786317825, -0.1352832168340683, -0.08585244417190552, -0.06625121831893921, -0.058847278356552124, 0.024791952222585678, 0.020999722182750702]", "userId": 1, "jsonName": "UFD.1.json"}]
# response = requests.post(BASE + "add_descriptor/1", json=data)
# response = requests.get(BASE + "recognize/"+camera+"/"+str(width)+"/"+str(height)+"/"+str(upsample_rate)+ "/"+str(recognize_ms) +"/"+str(threshold))
# print(response.json())
#

source = "http://127.0.0.1:5000/video_recognition/0/1024/768/0/10/0.3/0/0.22/2"

# source = "http://127.0.0.1:5000/video_detection/0/1024/768/0/1"

video = cv2.VideoCapture(source)
# video.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
# video.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)

# nome da janela que será aberta para exibir a msg
windowName = "window"
cv2.namedWindow(windowName)

# definindo fullscreen a fim de que ela fique na posição x: 0 e y: 0
cv2.setWindowProperty(windowName, cv2.WND_PROP_FULLSCREEN, cv2.WINDOW_FULLSCREEN)

while video.isOpened():

    ret, image = video.read()

    if ret is True:
        resizedFrame = cv2.resize(image, (width, height), interpolation=cv2.INTER_AREA)
        new_img = adjust_gamma(resizedFrame, 1)
        cv2.imshow(windowName, new_img)
    else:
        break

    # USUÁRIO CANCELOU VISUALIZAÇÃO
    if cv2.waitKey(1) == ord("q"):
        break

video.release()
cv2.destroyAllWindows()
